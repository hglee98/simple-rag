# 내 휴가를 WSC 리버스 엔지니어링으로 망친 이야기


* **Windows Security Center(WSC) 서비스 API**를 직접 활용하여 Windows Defender를 비활성화하는 도구인 defendnot 개발 과정에 대한 경험 공유임
* 프로젝트는 **이전 no-defender** 프로젝트의 기술적 한계와 법적 문제를 극복하는 과정에서 시작됨
* **특수 환경(맥북 arm64, 원격 디버깅, 높은 지연)** 등 여러 가지 장애물 속에서 리버스 엔지니어링과 디버깅을 진행함
* **Defender 등록 우회 및 프로세스 검증 메커니즘** 분석, 여러 실패와 시도 끝에 안정적으로 동작하도록 개선함
* 최종적으로 **자동 실행 기능**까지 구현 완료함과 동시에, 프로젝트 과정을 돌아보며 힘들었던 점을 고백함

---

소개
--

* Windows Defender를 비활성화하는 **defendnot** 도구의 구현 여정 경험 공유임
* 주요 기술적 세부 사항 설명 대신, **실제 환경에서 겪은 문제와 삽질 경험** 중심으로 정리됨
* 정식 문서화 및 기술적 설명은 이후 별도로 공개될 예정임

1년 전 회상
-------

* 약 1년 전에 **no-defender**라는 프로젝트를 공개하여, WSC API를 통해 Windows Defender가 비활성화되는 구조를 활용함
* 이 프로젝트는 안티바이러스 공급 업체의 **서드파티 코드**를 참조함으로써, 시스템에 다른 안티바이러스가 등록된 것처럼 속임
* 출시 후 큰 관심을 받으며 약 1,500개의 Star를 얻었으나, 관련 안티바이러스 업체의 **DMCA 삭제 요청**으로 인해 소스 삭제 및 프로젝트 종료를 결정함

프로젝트 시작 계기
----------

* 현재 글 작성 당시 서울에서 airbnb에 체류 중임
* 주요 개발 환경은 **M4Pro MacBook**이며, 필수적인 x86 리버스 엔지니어링용 기기를 따로 챙기지 않음
* **CTF 대회 및 여행 일정**으로 인해 x86 디바이스 없이 작업을 진행해야 하는 상황 발생
* no-defender 프로젝트의 "정상적인" 구현 가능성 검토와 함께, **AV 무관 단독 구현**이 가능한지 탐색 시작임

초기 조사 (1일차)
-----------

* 친구의 도움으로 **wsc 바이너리**를 제공받아, 이전 프로젝트와 유사한 구조로 WSC 등록 재구현 시도임
* WSC의 **COM API** 활용해 구현했으나, Access Denied 오류 발생함
* 오류 원인을 WSC가 **API 호출 프로세스의 서명 검증** 및 인증 과정에서 찾음
* AV 프로세스에 모듈을 인젝션하여 등록을 시도했을 때 성공적으로 AV가 등록됨

AV 바이너리 대체 및 추가 실험 (1일차)
------------------------

* 서명된 시스템 프로세스(cmd.exe 등)를 통해 도구 실행 시도, **PPL(Protected Process Light) 검증**에서 실패 경험함
* 분석을 위해 자세한 디스어셈블 및 추적을 기약하고 일시 중단함

환경 구축 (2일차)
-----------

* arm64 **MacBook** 환경의 한계로 x86 Windows 디버깅이 매우 어려운 상황임
* 미국에 사는 친구의 PC를 원격(Parasec, Anydesk 등)으로 이용하여, **고지연 환경** 하에서 디버깅 및 실험 진행함
* 코드 빌드와 VM 디버깅이 복잡하게 교차되는 과정에서 속도 저하와 혼란 경험함

WSC 서비스 디버깅 (2일차)
-----------------

* WSC 서비스가 **svchost에 의해 실행되는 DLL** 구조임을 확인함
* **PPL 보호 해제**를 위해 특수 드라이버로 우회 적용, 디버거로 함수 진입 확인함
* 서비스 내부에서 **WinDefend SID 토큰 확인**이 실행되고 있음을 파악함
* WinDefend SID를 가진 프로세스 모방 시도를 통해 인증 절차를 우회하려는 이론 수립함

WinDefend SID 모방 (2일차)
----------------------

* Windows의 토큰 구조와 동작 원리에 대한 추가 학습 수행함
* WinDefend SID 모방 코드 구현 및 실행 후, 모든 COM 호출에서 SUCCESS 리턴되지만 실제로 AV 등록이 이루어지지 않는 정황 확인함

검증 알고리듬 재구성 (3일차)
-----------------

* AV 바이너리에서 SID 체크가 정말 통과되는지 신중히 재분석함
* **SID 체크 미통과**시, 서비스가 권한 상승 상태, 바이너리 서명, PE의 DllCharacteristics 플래그(ForceIntegrity) 등을 추가 확인함
* 해당 구조 수행 함수 재현, 시스템 내 core 바이너리에 적용해 실험 진행함

Taskmgr 프로세스 활용 (3일차)
---------------------

* Taskmgr.exe를 대상 프로세스 삼아 재실험했으나, **이름 전달 과정 오류 및 IPC 버그**로 인해 WSC가 요청을 거부하는 문제 겪음
* 파일 경로 추론 및 AV 이름 전달 방식 개선 후 정상 동작 확인함

코드 정리 (3일차)
-----------

* 기능 정리 및 **자동 실행(autorun) 기능** 구현 시도함
* 자동 실행 관리에서 간헐적 실패를 겪고, 원인 규명을 위해 코드와 환경 점검 반복함

자동 실행 구현 (4일차)
--------------

* 작업 스케줄러(Task Scheduler) 옵션 중, **노트북이 AC 전원에 연결되지 않았을 때** 작업이 실행되지 않도록 체크박스가 설정된 것이 원인임을 확인함
* 해당 설정 해제 후 자동 실행이 정상적으로 동작함
* 마무리로 코드 클린업 및 테스트 수행함

결론
--

* 제한적이고 불편한 환경에서의 리버스 엔지니어링 작업이 **심리적/물리적으로 매우 힘든 경험**이었음
* 차후 더 상세한 WSC 구현 문서는 별도로 공개될 예정임

감사 인사
-----

* **Pindos**: PC를 야간에 제공해 디버깅을 돕고 방을 데워준 친구임
* **MrBruh**: 프로젝트 탐구를 시작하도록 자극 및 아이디어 피드백을 제공한 동료임
* 프로젝트 기간 함께 연락하며 힘이 되어준 지인들임
* 김치를 사랑함을 고백함
* 우리의 벽에 그래피티를 남긴 예술가에게도 감사함
