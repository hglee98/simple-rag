# KVSplit - 애플 실리콘에서 2-3배 더 긴 컨텍스트 실행


* **KVSplit**은 애플 실리콘에서 **대형 LLM**과 긴 컨텍스트 윈도우를 실행할 수 있게 하는 오픈소스 프로젝트임
* **키와 값의 분리된 정밀도 할당**을 통해 **최대 72% 메모리 감소**와 품질 저하 1% 미만을 달성함
* **M1/M2/M3** 칩 및 Metal 프레임워크에 최적화되어 있음
* **실행 속도 개선** 및 메모리 절약을 실측 벤치마크와 시각화 도구로 증명함
* 손쉬운 설치, 원커맨드 비교, 그리고 다양한 **벤치마크 및 분석 도구**를 제공함

---

소개: 왜 KVSplit가 중요한가
-------------------

KVSplit은 **KV 캐시 내부의 키와 값에 상이한 정밀도의 양자화**를 적용함으로써 애플 실리콘(M1/M2/M3) 환경에서 대용량 LLM과 훨씬 긴 컨텍스트 윈도우 실행을 가능하게 하는 오픈소스 도구임. 기존 프로젝트들이 키와 값을 동일하게 양자화하는 한계를 극복하고, **메모리 사용량을 획기적으로 감축**하면서도 품질 저하를 거의 느끼기 어려운 수준으로 억제함. **실제 벤치마크, 속도, 그리고 품질 지표가 모두 공개**되어 있어 신뢰할 수 있으며, **Metal 지원**과 직관적인 비교 및 시각화 툴로 개발 효율성이 높음.

동종 프로젝트 대비 주요 장점은 다음과 같음:

* **키-값 정밀도 분리**로 한층 효율적인 메모리 관리 실현
* **애플 실리콘 특화** 및 풀 Metal 프레임워크 최적화 지원
* **벤치마크, 퍼플렉서티, 메모리/속도/품질 측정 및 시각화** 통합 제공
* **원커맨드 설치, 모델 호환, llama.cpp 통합**
* 실시간 **메모리 절감 시각화** 및 다양한 비교 테스트 도구

주요 특징 및 핵심 내용
-------------

### 개요

* **KVSplit**을 이용하면 기존보다 **훨씬 더 큰 LLM**과 **긴 컨텍스트 길이**를 애플 실리콘에서 실행 가능함
* **키와 값 각각에 다르게 양자화 정밀도를 할당**하여 메모리 절감과 속도 개선을 모두 달성함
* **최대 72% 메모리 절약** 및 **속도 개선(5-15%↑)** , 품질 저하 1% 미만 확인됨
* **Metal** 완전 지원, **최적의 애플 실리콘 가속효과** 실현

### 주요 벤치마크 결과

* **K8V4(키 8비트, 값 4비트)** 구성에서
  + **59% 메모리 절감** 및 **0.86% 품질 저하(퍼플렉서티 기준)**
  + **FP16** 대비 **5.7% 속도 향상**
* **K4V4(키/값 모두 4비트)** 구성에서는
  + 최대 **72% 메모리 절감**
  + 품질 약 **6% 손실** 발생. 품질 민감도가 낮은 용도에 추천

### 메모리 절감 효과 비교

* **FP16 기준** 176MB(8K 토큰)에서
  + **K8V8(8비트 키/값)** : 93.5MB(47%)
  + **K8V4(8비트 키, 4비트 값)** : 71.5MB(41%)
  + **K4V4(4비트 키/값)** : 49.5MB(28%)

### 주요 기능

* **KV 캐시 키·값 개별 양자화** 기능
* **애플 실리콘·Metal 완전 최적화**
* **벤치마크/품질(퍼플렉서티)/메모리 사용량** 분석 스크립트
* **시각화 툴 및 퍼블리케이션 품질의 그래프 생성**
* **원커맨드 셋업과 실시간 비교 기능**

### 프로젝트 폴더 구성

* llama.cpp: Metal 최적화 빌드 포함
* models: 모델 파일 저장
* scripts: 벤치마크/설치/비교/시각화 스크립트 포함
* results, plots: 벤치마크 결과 및 시각화 파일 저장
* README.md

과학적 인사이트 및 실험 결과
----------------

### KV 캐시의 핵심 현상

* **키 벡터**는 **양자화 민감도가 값 벡터보다 훨씬 높음** → 키에 더 높은 정밀도를 할당해야 품질 유지가 가능함
* **K8V4가 Sweet Spot**: 키 8비트/값 4비트 배분이 품질-메모리 절충 최적임
  + 59% 메모리 절약, 퍼플렉서티 0.86%만 악화, 속도도 FP16보다 빠름
* **K4V8**은 K8V4와 같은 비트수임에도 **7배 이상 더 큰 품질 저하** 발생 → 키 쪽 정밀도 중요성 입증

### 종합적인 시사점

* **메모리 효율 확보**와 **모델 품질 보존**을 모두 실현 → 소비자용 하드웨어에서 훨씬 더 긴 컨텍스트와 큰 모델 운용 가능

사용 예시 및 설정 추천
-------------

### 다양한 양자화 정밀도로 실행 예시

* **기본(FP16):** ./llama.cpp/build/bin/llama-cli -m models/your-model.gguf -p "프롬프트" -t 8 --flash-attn
* **K8V4 추천:** --kvq 8
* **K4V8(DEMO):** --kvq-key 4 --kvq-val 8
* **K4V4(최대 절감):** --kvq 4

### 긴 컨텍스트 예시

* 32K 컨텍스트: FP16은 ~1.4GB 필요하지만 **K8V4는 ~400MB로 실행 가능**

### 커맨드라인 플래그 설명

* `-t 8`: 스레드 수, M1/M2/M3에 8추천
* `--flash-attn`: 애플 실리콘 최적화
* `--kvq N`: 키/값 모두 N비트 설정
* `--kvq-key`, `--kvq-val`: 개별 설정 지원
* `-c N`: 컨텍스트 토큰 수(길수록 KVSplit 효과 극대)
* `-n N`: 생성 토큰 수
* `-f FILE`: 문서 입력 파일
* `-m MODEL`: 모델 경로

고급 벤치마킹 및 시각화
-------------

* **benchmark\_kvsplit.py**로 구성별, 시퀀스 길이별, 메모리/속도/퍼플렉서티/스케일 특성 측정
* **visualize\_results.py**로 논문 수준 그래프 생성
* 결과는 CSV/JSON 자동저장 및 요약 제공

애플 실리콘 최적화 및 메모리 시각화
--------------------

* **Metal 프레임워크** 완전 활용
* 메모리 부담 큰 M1/M2/M3 기종에 결정적 효과
* **capture\_memory.sh**로 실시간 메모리 절감 시각화 가능
* 맞춤 페이지 정렬로 실제 절감 용량은 이론치와 소폭 차이 발생

요약 기능 정리
--------

* **독립 키/값 비트 정밀도** 및 맞춤형 양자화
* **애플 실리콘** 및 Metal 완전 최적화
* 메모리/속도/품질 **종합 벤치마크** 제공
* 논문 품질 **시각화 및 실시간 비교**, 메모리 캡처 지원
* **초간단 설치/사용 인터페이스**

인용 및 참고 연구
----------

* "More for Keys, Less for Values: Adaptive KV Cache Quantization"(2024)
* "Unifying KV Cache Compression for Large Language Models with LeanKV"(2025)
* 기반 구현: [llama.cpp], 테스트 모델: [TinyLlama]

설정 추천 및 향후 계획
-------------

* **K8V4(키 8비트/값 4비트)** : 품질 손실 0.86%, 메모리 59% 절감, 속도 +5.7%로 최적의 균형
* **K4V4**: 최대 메모리 절감(72%), 품질 약 6% 하락. 메모리 최우선시 용도에 적합
* **긴 컨텍스트 실행**에 특히 강점, 2-3배 더 긴 컨텍스트 운용 가능

### 향후 로드맵

* 토큰 중요도 기반 **적응형 정밀도**
* 레이어별 개별 양자화
* 모델별 맞춤 최적화(Mistral, Phi-3 등)
* **웹 데모** 및 모바일(iOS/iPadOS) 지원 예정

라이선스 및 기여 안내
------------

* MIT 라이선스
* 개발자/AI 연구자 누구든지 Issue 및 PR로 기여 가능
